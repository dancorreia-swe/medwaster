{
    # Global options
    # For Let's Encrypt with public domains, uncomment and set LETSENCRYPT_EMAIL in .env:
    # email your-email@example.com

    # For local domains (.local, .lan), no email needed - Caddy uses internal CA

    # Enable admin API (useful for debugging)
    admin :2019
}

# Main site configuration
{$DOMAIN:localhost} {
    # Force internal CA for local domains (.local, .lan, localhost)
    # This prevents Caddy from trying to use Let's Encrypt for non-public domains
    tls internal

    # For local domains, trust Caddy's root CA certificate:
    # docker compose cp caddy:/data/caddy/pki/authorities/local/root.crt caddy-root.crt
    # Then install caddy-root.crt in your browser/system trust store

    # API routes - proxy to server
    handle /api/* {
        reverse_proxy server:4000 {
            # Health check
            health_uri /api/health
            health_interval 30s
            health_timeout 10s

            # Forward real IP
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # MinIO console (optional, can be removed if not needed)
    handle /minio/* {
        reverse_proxy minio:9001 {
            header_up Host {upstream_hostport}
        }
    }

    # MinIO S3 API (optional, can be removed if not needed)
    handle /s3/* {
        uri strip_prefix /s3
        reverse_proxy minio:9000 {
            header_up Host {upstream_hostport}
        }
    }

    # Web app - proxy to nginx serving static files
    handle {
        reverse_proxy web:3000 {
            # Health check
            health_uri /health
            health_interval 30s
            health_timeout 5s
        }
    }

    # Security headers
    header {
        # Remove server information
        -Server

        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"

        # HSTS (only for HTTPS)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 10
        }
        format json
    }

    # Error handling
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}

# LocalAI UI/API on its own host (avoids broken absolute links under subpaths)
{$LOCALAI_HOST:ai.localhost} {
    tls internal
    reverse_proxy localai:8080
}
